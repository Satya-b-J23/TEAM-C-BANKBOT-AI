GEMINI_API_KEY=AIzaSyDdtY-HKB4JyZtGP7WKuRk2D5xl30qKUf4

# BANKBOT - FINAL MILESTONE (BANKING ONLY)
# RULE + AI HYBRID | MULTI-LANGUAGE | VOICE ENABLED

import streamlit as st
import requests
import json
import os
import pyttsx3
from datetime import datetime

# -----------------------------
# CONFIG
# -----------------------------
MODEL_NAME = "qwen2.5:0.5b"

BASE_PROMPT = (
    "You are a banking assistant. "
    "Answer ONLY banking-related questions clearly and professionally. "
    "Politely refuse non-banking questions."
)

CHAT_FILE = "chat_history.json"
BANK_LIB_FILE = "banking_library.json"

# -----------------------------
# LANGUAGE SUPPORT
# -----------------------------
LANGUAGES = {
    "English": "Respond in English.",
    "Tamil": "Respond in simple Tamil.",
    "Hindi": "Respond in simple Hindi."
}

# -----------------------------
# LOAD BANK LIBRARY
# -----------------------------
with open(BANK_LIB_FILE, "r", encoding="utf-8") as f:
    BANK_LIBRARY = json.load(f)

# -----------------------------
# BANKING KEYWORDS
# -----------------------------
BANKING_KEYWORDS = {
    "bank", "account", "balance", "loan", "emi", "interest",
    "deposit", "withdraw", "atm", "card", "debit", "credit",
    "ifsc", "branch", "cheque", "fd", "rd",
    "kyc", "passbook", "statement", "transaction",
    "savings", "current"
}

def is_banking_question(text):
    text = text.lower()
    return any(k in text for k in BANKING_KEYWORDS)

# -----------------------------
# CHAT STORAGE
# -----------------------------
def load_all_sessions():
    if not os.path.exists(CHAT_FILE):
        return {"sessions": []}
    with open(CHAT_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_all_sessions(data):
    with open(CHAT_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)

def save_current_chat():
    if st.session_state.current_chat:
        data = load_all_sessions()
        data["sessions"].append({
            "time": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "messages": st.session_state.current_chat
        })
        save_all_sessions(data)

# -----------------------------
# BANK DATA
# -----------------------------
ACCOUNTS = [
    {"account_number": "1001", "name": "Surya Jai", "pin": "1234", "balance": 50234.75},
    {"account_number": "1002", "name": "Ravi Kumar", "pin": "5678", "balance": 28900.00},
    {"account_number": "1003", "name": "Anitha Devi", "pin": "4321", "balance": 74000.50},
]

def find_account(acc_no):
    return next((a for a in ACCOUNTS if a["account_number"] == acc_no), None)

# -----------------------------
# RULE-BASED BANK LIBRARY
# -----------------------------
def check_bank_library(text):
    t = text.lower()
    for item in BANK_LIBRARY.values():
        for kw in item["keywords"]:
            if kw in t:
                return item["answer"]
    return None

# -----------------------------
# OLLAMA CALL
# -----------------------------
def call_ollama(prompt):
    try:
        with st.spinner("ü§ñ BankBot is thinking..."):
            r = requests.post(
                "http://localhost:11434/api/generate",
                json={
                    "model": MODEL_NAME,
                    "prompt": prompt,
                    "stream": False,
                    "options": {"num_predict": 180, "temperature": 0.2}
                },
                timeout=40
            )
        return r.json().get("response", "").strip()
    except Exception:
        return "‚ö†Ô∏è AI service unavailable."

# -----------------------------
# VOICE OUTPUT
# -----------------------------
def speak(text):
    try:
        engine = pyttsx3.init()
        engine.setProperty("rate", 160)
        engine.say(text)
        engine.runAndWait()
    except:
        pass

# -----------------------------
# STREAMLIT UI
# -----------------------------
st.set_page_config("BankBot", layout="wide")
st.title("üè¶ BankBot ‚Äì Banking-AI Assistant")

# -----------------------------
# SESSION STATE
# -----------------------------
st.session_state.setdefault("current_chat", [])
st.session_state.setdefault("search", "")
st.session_state.setdefault("language", "English")

# -----------------------------
# SIDEBAR
# -----------------------------
with st.sidebar:
    st.header("üîß Controls")

    st.selectbox("üåç Language", LANGUAGES.keys(), key="language")

    col1, col2 = st.columns(2)
    if col1.button("üÜï New Chat"):
        save_current_chat()
        st.session_state.current_chat = []
        st.success("New chat started")

    if col2.button("üóëÔ∏è Clear All"):
        save_all_sessions({"sessions": []})
        st.session_state.current_chat = []
        st.success("All chats deleted")

    st.divider()

    st.subheader("üïò Previous Chats")
    st.text_input("üîç Search history", key="search")

    data = load_all_sessions()
    query = st.session_state.search.lower().strip()

    with st.container(height=300):
        for session in reversed(data["sessions"]):
            for role, msg in session["messages"]:
                if query and query not in msg.lower():
                    continue
                st.markdown(f"**{role}:** {msg}")

# -----------------------------
# MAIN CHAT
# -----------------------------
st.subheader("üí¨ Current Chat")

for role, msg in st.session_state.current_chat:
    st.markdown(f"**{role}:** {msg}")

if st.session_state.current_chat:
    last_bot = st.session_state.current_chat[-1][1]
    if st.button("üîä Speak Last Reply"):
        speak(last_bot)

st.divider()

# -----------------------------
# INPUT
# -----------------------------
with st.form("chat_form", clear_on_submit=True):
    user_text = st.text_input("Ask a banking question‚Ä¶")
    send = st.form_submit_button("Send")

    if send and user_text.strip():
        st.session_state.current_chat.append(("You", user_text))

        rule_answer = check_bank_library(user_text)

        if rule_answer:
            reply = rule_answer

        elif not is_banking_question(user_text):
            reply = "‚ùå I answer only banking-related questions."

        else:
            lang_instruction = LANGUAGES[st.session_state.language]
            reply = call_ollama(
                f"{BASE_PROMPT}\n{lang_instruction}\nUser: {user_text}\nAssistant:"
            )

        st.session_state.current_chat.append(("Bot", reply))
        st.rerun()

st.caption("‚úî Final Milestone ‚Äì Banking-Only | Local AI | Multilingual | Voice Enabled")
